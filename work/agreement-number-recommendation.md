# Agreement Number: Recommendation

## Recommendation: Auto-generate on confirmation, keep an optional external reference field

Generate an internal Likha agreement number automatically when the user confirms a
contract (transitions from draft to active). Also store an optional `external_ref`
field where the user can record the number their licensee uses in their own system.
Do not ask users to invent or type an agreement number themselves.

---

## Rationale by question

### 1. Auto-generate or ask the user?

Auto-generate. Our target user is a small brand owner running one to five agreements
out of spreadsheets. Asking them to devise a unique, stable, scan-friendly reference
number adds friction at a moment when they are already reviewing extracted contract
terms. They will either skip the field (leaving Signal 2 permanently dead for that
contract) or enter something inconsistent ("Lic-Disney-1", "disney1", "001") that
the licensee will never reproduce in a report header.

The only real argument for user-entry is that the licensee's system already has its
own reference number, and their reports will cite that number — not ours. That
concern is real, but it is addressed by the `external_ref` field (see below), not by
making the user invent an internal number.

The "Both" option — auto-generate plus an optional user field — is the right shape.
The auto-generated number is our internal identifier; `external_ref` captures what
the licensee actually prints on their reports.

### 2. Format: `LKH-{year}-{sequential}`

Recommended format: `LKH-2025-001`, `LKH-2025-002`, etc.

Rationale:
- `LKH-` is a short, unambiguous prefix we fully control; it will never collide with
  `Lic-`, `AGR-`, or any pattern the licensee already uses internally.
- Including the year makes the number self-describing and makes a document audit trail
  easier to follow without opening the app.
- Three-digit sequential is sufficient for the target user (1-5 active agreements at
  any time; total portfolio rarely exceeds dozens over the contract lifetime). Pad to
  three digits so sorting is stable: `LKH-2025-001` sorts before `LKH-2025-010`.
- Uniqueness is per-user per-year. Two users can both have `LKH-2025-001`; that is
  fine because agreement numbers are never shared across user accounts.

Sequential counter: derive it from `COUNT(*) + 1` of active contracts for that user
in that calendar year at confirmation time. This is simple and good enough for the
target scale. If exact collision resistance is needed later (concurrent confirmations
in the same second), add a `UNIQUE` constraint on `(user_id, agreement_number)` and
retry on conflict.

### 3. When is it generated?

On confirmation (`PUT /{id}/confirm`), not on draft creation.

A draft may be abandoned. Generating a number on draft creation would create gaps in
the sequence and cause confusion ("I have LKH-2025-003 but no LKH-2025-002 — what
happened to it?"). The number should only exist when the contract is real and active.

It does not change after assignment. Agreement numbers appearing on executed contracts
and in report correspondence must be stable.

### 4. How does Signal 2 change?

Simplify Signal 2 materially. The current implementation uses `re.escape` on whatever
string is stored in `agreement_number` and searches for it verbatim. That already
works for any format. No change to the matching logic is required.

What changes is confidence: because we now guarantee every active contract has an
`agreement_number` (the field is populated at confirmation, not left null), Signal 2
will run against every contract on every email that has an attachment — not only the
subset where the user happened to fill in the field. The ADR's own consequence note
called out this gap explicitly; auto-generation closes it.

The legacy patterns (`Lic-\d+`, `AGR-\d+`, `Agreement #\d+`) listed in the ADR spec
are no longer needed as a scan target. They were a placeholder for "whatever format
the user entered." With a known prefix of `LKH-`, the regex is deterministic. Remove
the legacy pattern list from the spec; the actual search remains `re.escape(agr_num)`
against the attachment text, which handles `LKH-2025-001` correctly.

Keep Signal 2 as a high-confidence signal. If the attachment contains `LKH-2025-001`
and exactly one active contract has that number, the match is unambiguous.

### 5. Will licensees actually include our agreement number?

Probably not by default. This is the central practical risk. A licensee's royalty
report is generated by their own ERP or spreadsheet template, not ours, and it will
cite their internal PO number or their own contract reference — not `LKH-2025-001`.

Signal 2 fires only when the licensee includes our number. To make that more likely:

- Show the agreement number prominently on the contract detail page, next to the
  licensee name, with a copy button. Make it look like a reference number they should
  use, not a database field.
- Generate a short cover-letter template (plain text, one paragraph) that the user
  can send to their licensee when the contract goes active. The template says: "Please
  include agreement number LKH-2025-001 in the subject line or header of all royalty
  reports sent to [inbound address]." This is a one-time ask, not a recurring burden.
- On the inbox detail page, when Signal 2 is what fired, show the matching evidence:
  "Matched on agreement number LKH-2025-001 found in attachment." This reinforces to
  the user that asking licensees to include the number actually works.

If a licensee never includes the number, Signal 2 does not fire for their reports —
but Signal 1 (exact sender email) and Signal 3 (licensee name in attachment) still
do. Signal 2 is a bonus signal, not a dependency. The value of auto-generation is
that it makes Signal 2 available for every contract with zero user effort, so any
licensee who does include it gets the benefit automatically.

---

## Changes required

**Schema**

- `contracts.agreement_number` — change from optional/user-entered to auto-populated
  on confirmation. Add a `UNIQUE` constraint on `(user_id, agreement_number)` since
  the value is now system-generated and must not collide.
- `contracts.external_ref` — new optional text column. No constraint; free-form.
  This is where the user records whatever reference the licensee uses (e.g. "PO-4492"
  or "Disney-LIC-07"). Signal 2 should also scan `external_ref` if populated, as a
  secondary string after `agreement_number`.

**Backend**

- `PUT /{id}/confirm` in `backend/app/routers/contracts.py` — compute and insert
  `agreement_number` using format `LKH-{year}-{sequential:03d}` before writing the
  confirmed row.
- `ContractConfirm` in `backend/app/models/contract.py` — remove `agreement_number`
  as a user-supplied field; add `external_ref: Optional[str] = None`.
- `Contract` model — `agreement_number` becomes non-optional for active contracts;
  `external_ref` added as optional.
- `_auto_match_contract` in `backend/app/routers/email_intake.py` — after matching
  on `agreement_number`, also check `external_ref` if `agreement_number` did not
  match. Both use `re.escape` search; `agreement_number` takes priority.

**Frontend**

- Contract confirm form — remove the agreement number input field. Add an optional
  "Licensee's reference number" input that maps to `external_ref`, with helper text:
  "If your licensee uses their own reference (e.g. a PO number), enter it here. We
  will try to match inbound reports against it automatically."
- Contract detail page — display `agreement_number` (e.g. `LKH-2025-001`) in a
  prominent position with a copy button and a "Share with licensee" hint.
- Post-confirmation — show a dismissible callout: "Agreement number LKH-2025-001
  assigned. Ask your licensee to include it in all emailed reports."
